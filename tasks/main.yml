---
# Software installation
- name: download .deb file
  get_url:
    dest={{ temp_dir }}/zabbix-release_2.2-1+precise_all.deb
    url=http://repo.zabbix.com/zabbix/2.2/ubuntu/pool/main/z/zabbix-release/zabbix-release_2.2-1+precise_all.deb
    mode=0644
  tags:
    - zabbix
    - packages

- name: install from .deb package
  command: dpkg --skip-same-version --install {{ temp_dir }}/zabbix-release_2.2-1+precise_all.deb
  register: dpkg_result
  changed_when: "dpkg_result.stdout.startswith('Selecting')"
  tags:
    - zabbix
    - packages

- name: refreash apt cache
  apt: update_cache=yes
  when: dpkg_result|changed
  tags:
    - zabbix
    - packages

- name: ensure packages are installed
  apt: pkg={{item}}
  with_items:
    - php5-pgsql
    - zabbix-proxy-pgsql
  notify:
    - restart zabbix proxy
  tags:
    - zabbix
    - packages

- name: set local database host within the configuration
  lineinfile:
    dest=/etc/zabbix/zabbix_proxy.conf
    regexp="^DBHost="
    line="DBHost="
  when: zabbix_database_host is not defined
  notify:
    - restart zabbix proxy
  tags:
    - zabbix
    - configuration
    - database

- name: set remote database host within the configuration
  lineinfile:
    dest=/etc/zabbix/zabbix_proxy.conf
    regexp="^DBHost="
    line="DBHost={{ zabbix_database_host }}"
  when: zabbix_database_host is defined
  notify:
    - restart zabbix proxy
  tags:
    - zabbix
    - configuration
    - database

- name: set database name within the configuration
  lineinfile:
    dest=/etc/zabbix/zabbix_proxy.conf
    regexp="^DBName="
    line="DBName=zabbix"
  notify:
    - restart zabbix proxy
  tags:
    - zabbix
    - configuration
    - database

- name: set database password within the configuration
  lineinfile:
    dest=/etc/zabbix/zabbix_proxy.conf
    regexp="^DBPassword="
    line="DBPassword={{ zabbix_database_password }}"
  notify:
    - restart zabbix proxy
  tags:
    - zabbix
    - configuration
    - database

- name: set database socket within the configuration
  lineinfile:
    dest=/etc/zabbix/zabbix_proxy.conf
    regexp="DBSocket=/var/run/mysqld/mysqld.sock"
    line="# DBSocket=/var/run/mysqld/mysqld.sock"
  notify:
    - restart zabbix proxy
  tags:
    - zabbix
    - configuration
    - database

- name: set database port within the configuration
  lineinfile:
    dest=/etc/zabbix/zabbix_proxy.conf
    insertafter="# DBPort=3306"
    line="DBPort=5432"
  notify:
    - restart zabbix proxy
  tags:
    - zabbix
    - configuration
    - database

- name: set master server address within the configuration
  lineinfile:
    dest=/etc/zabbix/zabbix_proxy.conf
    regexp="Server="
    line="Server={{ zabbix_server_address }}"
  notify:
    - restart zabbix proxy
  tags:
    - zabbix
    - configuration

- name: set host proxy name within the configuration
  lineinfile:
    dest=/etc/zabbix/zabbix_proxy.conf
    regexp="Hostname="
    line="Hostname={{ ansible_hostname }}"
  notify:
    - restart zabbix proxy
  tags:
    - zabbix
    - configuration

- name: create psql password file
  sudo: yes
  sudo_user: postgres
  template:
    dest=/var/lib/postgresql/.pgpass
    src=pgpass.j2
    mode=0600
  tags:
    - zabbix
    - configuration
    - database

- name: ensure supporting ansible packages are installed for database management
  action: apt name={{item}}
  with_items:
    - libpq-dev
    - python-psycopg2
  tags:
    - zabbix
    - database
    - package

- name: change zabbix database user password
  sudo: yes
  sudo_user: postgres
  postgresql_user:
    login_host={{ zabbix_database_host|default('localhost') }}
    encrypted=no
    name=zabbix
    password={{ zabbix_database_password }}
  tags:
    - zabbix
    - configuration
    - user
    - database

- name: create database
  sudo: yes
  sudo_user: postgres
  postgresql_db:
    login_host={{ zabbix_database_host|default('localhost') }}
    name=zabbix
    owner=zabbix
    encoding=UTF-8
    lc_collate=en_US.UTF-8
    lc_ctype=en_US.UTF-8
    template=template0
  register: zabbix_database
  tags:
    - zabbix
    - setup
    - database

- name: initialize database schema
  sudo: yes
  sudo_user: postgres
  shell: "psql --file=/usr/share/zabbix-proxy-pgsql/schema.sql --host={{ zabbix_database_host|default('localhost') }} zabbix zabbix"
  when: zabbix_database|changed
  register: database_initialised
  tags:
    - zabbix
    - database

- name: remove psql password file
  sudo: yes
  sudo_user: postgres
  file:
    dest="/var/lib/postgresql/.pgpass"
    state=absent
  tags:
    - zabbix
    - configuration
    - database

- name: stop local postgresql server
  service:
    name=postgresql
    state=stopped
  when: zabbix_database_host is defined and zabbix_database_host is not "localhost"
  tags:
    - zabbix
    - database
